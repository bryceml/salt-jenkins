// The maximum number of hours a build should run for
def global_timeout = 8

def ec2_region
def image_id
def tests_passed = false
def image_created = false
def image_to_promote_available
def ami_name_filter
def os_imager_tag

stage('Build Image') {
    node('kitchen-slave') {
        timeout(time: 1, unit: 'HOURS') {
            timestamps {
                ansiColor('xterm') {
                    cleanWs notFailBuild: true
                    os_imager_tag = sh (
                        script: '''
                        git ls-remote https://github.com/saltstack/os-imager.git|awk '{print $2}'|grep refs/tags/aws-ci-v|sort -V|tail -n 1
                        ''',
                        returnStdout: true
                        ).trim()
                    checkout([$class: 'GitSCM',
                        branches: [[name: "$os_imager_tag"]],
                        doGenerateSubmoduleConfigurations: false,
                        extensions: [],
                        submoduleCfg: [],
                        userRemoteConfigs: [[url: 'https://github.com/saltstack/os-imager.git']]
                        ])
                    ec2_region = 'us-west-2'
                    println "Using EC2 Region: ${ec2_region}"
                    salt_jenkins_head = sh (
                        script: '''
                        git ls-remote https://github.com/saltstack/salt-jenkins.git|grep refs/heads/develop\$ || true
                        ''',
                        returnStdout: true
                        ).trim()
                        if ( salt_jenkins_head != '' ) {
                            addInfoBadge id: 'discovered-salt-jenkins-head-badge', text: "salt-jenkins current head: ${salt_jenkins_head}"
                            createSummary(icon: "/images/48x48/attribute.png", text: "salt-jenkins current head: ${salt_jenkins_head}")
                        }
                    withAWS(credentials: 'os-imager-aws-creds', region: "${ec2_region}") {
                        sh """
                        env > /tmp/file.txt
                        /usr/sbin/ip a
                        pyenv install 3.6.8 || echo "We already have this python."
                        pyenv local 3.6.8
                        pip freeze | grep -s invoke || pip install -r requirements/py3.6/base.txt
                        inv build-aws --staging --distro=centos --distro-version=7 --salt-branch=develop
                        """
                    }
                    cleanWs notFailBuild: true
                }
            }
        }
    }
}

timeout(time: global_timeout + 1, unit: 'HOURS') {
    node('kitchen-slave') {
        timestamps {
            ansiColor('xterm') {
                withEnv([
                    "NOX_ENV_NAME=runtests-zeromq",
                    "NOX_PASSTHROUGH_OPTS=",
                    'NOX_ENABLE_FROM_FILENAMES=false',
                    "SALT_KITCHEN_PLATFORMS=/var/jenkins/workspace/nox-platforms.yml",
                    "SALT_KITCHEN_VERIFIER=/var/jenkins/workspace/nox-verifier.yml",
                    "SALT_KITCHEN_DRIVER=/var/jenkins/workspace/driver.yml",
                    "GOLDEN_IMAGES_CI_BRANCH=develop",
                    "PATH=~/.rbenv/shims:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin",
                    "RBENV_VERSION=2.4.2",
                    "TEST_SUITE=py3",
                    "TEST_PLATFORM=centos-7",
                    "KITCHEN_TESTS=integration.cli.test_grains integration.client.test_kwarg integration.grains.test_core integration.minion.test_pillar integration.modules.test_grains integration.reactor.test_reactor integration.returners.test_librato_return integration.runners.test_fileserver integration.sdb.test_env integration.states.test_cmd integration.states.test_service integration.wheel.test_key unit.cache.test_cache unit.fileserver.test_roots unit.grains.test_core unit.modules.test_config unit.modules.test_win_powercfg unit.output.test_yaml_out unit.pillar.test_sqlite3 unit.renderers.test_gpg unit.runners.test_cache unit.serializers.test_serializers unit.states.test_cmd unit.test_minion unit.utils.test_args unit.utils.test_event"
                ]) {
                    try {
                        // Checkout the repo
                        stage('Checkout') {
                            cleanWs notFailBuild: true
                            checkout([
                                $class: 'GitSCM',
                                branches: [
                                    [name: 'develop']
                                ],
                                doGenerateSubmoduleConfigurations: false,
                                extensions: [
                                    [
                                        $class: 'CloneOption',
                                        noTags: false,
                                        reference: '',
                                        shallow: true
                                    ]
                                ],
                                submoduleCfg: [],
                                userRemoteConfigs: [
                                    [url: "https://github.com/saltstack/salt/"]
                                ]
                            ])
                        }
                        // Setup the kitchen required bundle
                        stage('Setup') {
                            sh 'bundle install --with ec2 windows --without docker macos opennebula vagrant'
                            // Make sure we don't get any promoted images
                            writeFile encoding: 'utf-8', file: '.kitchen.local.yml', text: """\
                            driver:
                              image_search:
                                description: 'CI *'
                            verifier:
                              coverage: false
                            """.stripIndent()
                        }

                        stage('Discover AMI') {
                            command_output = sh returnStdout: true, script:
                                '''
                                bundle exec kitchen diagnose $TEST_SUITE-$TEST_PLATFORM | grep 'image_id:' | awk '{ print $2 }'
                                '''
                            image_id = command_output.trim()
                            if ( image_id != '' ) {
                                image_to_promote_available = true
                                addInfoBadge id: 'discovered-ami-badge', text: "Discovered AMI ${image_id} for this running instance"
                                createSummary(icon: "/images/48x48/attribute.png", text: "Discovered AMI: ${image_id}")
                            } else {
                                image_to_promote_available = false
                                addWarningBadge id: 'discovered-ami-badge', text: "No AMI discovered to promote"
                                createSummary(icon: "/images/48x48/warning.png", text: "No AMI discovered to promote")
                            }
                            command_output = sh returnStdout: true, script:
                                '''
                                grep 'region:' $SALT_KITCHEN_DRIVER | awk '{ print $2 }'
                                '''
                            ec2_region = command_output.trim()
                            println "Discovered EC2 Region: ${ec2_region}"
                            command_output = sh returnStdout: true, script:
                                '''
                                bundle exec kitchen diagnose $TEST_SUITE-$TEST_PLATFORM | grep 'name: saltstack/' | awk '{ print $2 }'
                                '''
                            ami_name_filter = command_output.trim()
                            println "Discovered AMI Name filter: ${ami_name_filter}"
                        }

                        timeout(time: global_timeout, unit: 'HOURS') {
                            stage('Create VM') {
                                if (image_to_promote_available) {
                                    retry(3) {
                                        sh '''
                                        t=$(shuf -i 1-15 -n 1); echo "Sleeping $t seconds"; sleep $t
                                        bundle exec kitchen create $TEST_SUITE-$TEST_PLATFORM; echo "ExitCode: $?;"
                                        '''
                                    }
                                    image_created = true
                                }
                            }
                            try {
                                stage('Converge VM') {
                                    if (image_to_promote_available) {
                                        sh '''
                                        ssh-agent /bin/bash -c 'ssh-add ~/.ssh/kitchen.pem; bundle exec kitchen converge $TEST_SUITE-$TEST_PLATFORM; echo "ExitCode: $?;"'
                                        '''
                                    }
                                }
                                stage('Verify VM') {
                                    if (image_to_promote_available) {
                                        withEnv(["DONT_DOWNLOAD_ARTEFACTS=1"]){
                                            try {
                                                sh '''
                                                bundle exec kitchen verify $TEST_SUITE-$TEST_PLATFORM; echo "ExitCode: $?;"
                                                '''
                                                tests_passed = true
                                            } catch (Exception e) {
                                                error("Tests Failed")
                                            }
                                        }
                                    }
                                }
                            } finally {
                                // Even if tests failed, mark the build as SUCCESS
                                currentBuild.result = 'SUCCESS'
                                stage('Cleanup VM') {
                                    sh '''
                                    bundle exec kitchen destroy $TEST_SUITE-$TEST_PLATFORM; echo "ExitCode: $?;"
                                    '''
                                }
                            }
                        }
                    } catch (Exception e1) {
                        currentBuild.result = 'FAILURE'
                        println "PIPELINE ERROR: ${e1}"
                    } finally {
                        cleanWs notFailBuild: true
                    }
                }
            }
        }
    }
}

stage('Promote AMI') {
    if (image_created) {
        try {
            try {
                message = "Salt@Develop Py3 Windows 2016 CI Golden Image Builds AMI `${image_id}` is waiting for CI duties promotion."
                if (tests_passed) {
                    message = "${message}\nTests Passed"
                } else {
                    message = "${message}\n*Tests Failed. Take extra care before promoting*."
                }
                message = "${message}\nPlease confirm or deny promotion <${env.BUILD_URL}|here>"
                slackSend(
                    channel: "#golden-images",
                    color: '#FF8243',
                    message: message)
            } catch (Exception e2) {
                sh "echo Failed to send the Slack notification: ${e2}"
            }
            message = "Salt@Develop Py3 Windows 2016 CI Golden Image Builds AMI `${image_id}` is waiting for CI duties promotion."
            if (tests_passed) {
                message = "${message}\nTests Passed."
            } else {
                message = "${message}\nTests Failed. Take extra care before promoting."
            }
            timeout(time: 4, unit: 'HOURS') {
                input id: 'promote-ami', message: "\n\n\n${message}\n\n\nPromote AMI ${image_id}?\n", ok: 'Promote!'
            }
            node('kitchen-slave') {
                cleanWs notFailBuild: true
                checkout([$class: 'GitSCM',
                          branches: [[name: "$os_imager_tag"]],
                          doGenerateSubmoduleConfigurations: false,
                          extensions: [],
                          submoduleCfg: [],
                          userRemoteConfigs: [
                              [url: 'https://github.com/saltstack/os-imager.git']
                          ]])
                withAWS(credentials: 'os-imager-aws-creds', region: "${ec2_region}") {
                    sh """
                    pyenv install 3.6.8 || echo "We already have this python."
                    pyenv local 3.6.8
                    pip freeze | grep -s invoke || pip install -r requirements/py3.6/base.txt
                    """
                }
                cleanWs notFailBuild: true
            }
            addBadge id: 'promoted-ami-badge', icon: "/static/8361d0d6/images/16x16/accept.png", text: "AMI ${image_id} was promoted for CI duties!"
            createSummary(icon: "/images/48x48/accept.png", text: "AMI ${image_id} was promoted for CI duties!")
            try {
                slackSend(
                    channel: "#golden-images",
                    color: '#00FF00',
                    message: "Salt@Develop Py3 Windows 2016 CI Golden Image Builds AMI `${image_id}` was promoted! (<${env.BUILD_URL}|open>)")
            } catch (Exception e3) {
                sh "echo Failed to send the Slack notification: ${e3}"
            }
        } catch (Exception e4) {
            println "AMI ${image_id} was NOT promoted for CI duties! Reason: ${e4}"
            addWarningBadge id: 'promoted-ami-badge', text: "AMI ${image_id} was NOT promoted for CI duties!"
            createSummary(icon: "/images/48x48/warning.png", text: "AMI ${image_id} was <b>NOT</b> promoted for CI duties!")
            try {
                slackSend(
                    channel: "#golden-images",
                    color: '#FF0000',
                    message: "Salt@Develop Py3 Windows 2016 CI Golden Image Builds AMI `${image_id}` was *NOT* promoted! (<${env.BUILD_URL}|open>)")
            } catch (Exception e5) {
                sh "echo Failed to send the Slack notification: ${e5}"
            }
        }
    }
}

stage('Cleanup Old AMIs') {
    if (ami_name_filter) {
        timeout(time: 10, unit: 'MINUTES') {
            node('kitchen-slave') {
                cleanWs notFailBuild: true
                checkout([$class: 'GitSCM',
                          branches: [[name: "$os_imager_tag"]],
                          doGenerateSubmoduleConfigurations: false,
                          extensions: [],
                          submoduleCfg: [],
                          userRemoteConfigs: [
                              [url: 'https://github.com/saltstack/os-imager.git']
                          ]])
                withAWS(credentials: 'os-imager-aws-creds', region: "${ec2_region}") {
                    sh """
                    pyenv install 3.6.8 || echo "We already have this python."
                    pyenv local 3.6.8
                    pip freeze | grep -s invoke || pip install -r requirements/py3.6/base.txt
                    """
                }
                cleanWs notFailBuild: true
            }
        }
    }
}

// vi: ft=groovy
